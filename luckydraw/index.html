<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucky Wheel — Ultra Neon</title>
<style>
  /* ============ THEME ============ */
  :root{
    --bg-1:#060712;
    --bg-2:#0a0d1f;
    --bg-3:#091129;
    --cyan:#00eaff;
    --pink:#ff3ca6;
    --vio:#7c5cff;
    --lime:#8aff7a;
    --text:#eaf4ff;
    --muted:#9ab0d7;
    --panel:#0c1228;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: Inter, Segoe UI, Roboto, system-ui, -apple-system, Arial, sans-serif;
    background:
      radial-gradient(1200px 600px at 15% -10%, #0d1c3f 0%, transparent 60%),
      radial-gradient(900px 500px at 85% 110%, #2b0c23 0%, transparent 60%),
      radial-gradient(800px 520px at 50% 30%, #041124 0%, transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-3));
    overflow-x:hidden;
  }
  /* animated neon grid */
  .neon-bg::before,.neon-bg::after{
    content:""; position:fixed; inset:-200vmax; pointer-events:none; z-index:0;
    background:
      repeating-linear-gradient(0deg, #00eaff14 0 2px, transparent 2px 40px),
      repeating-linear-gradient(90deg, #ff3ca614 0 2px, transparent 2px 40px);
    transform:rotate(12deg) translate3d(0,0,0);
    filter:blur(0.3px);
    animation:gridmove 30s linear infinite;
  }
  .neon-bg::after{
    animation-duration: 42s; opacity:.55; transform:rotate(-8deg);
  }
  @keyframes gridmove{ to{ transform:translate3d(-120px,-120px,0) rotate(12deg); } }

  /* header */
  .header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(180deg, rgba(5,8,20,.85), rgba(5,8,20,.35) 70%, rgba(5,8,20,0));
    backdrop-filter: blur(8px);
    border-bottom:1px solid #1a2b61;
  }
  .title{
    display:flex; align-items:center; justify-content:center; gap:.9rem;
    padding:18px 16px; font-weight:900; letter-spacing:.6px;
    text-transform:uppercase; font-size: clamp(22px, 3vw, 30px);
    text-shadow:0 0 12px #fff, 0 0 18px var(--cyan), 0 0 46px var(--cyan);
  }
  .title .dot{ width:12px; height:12px; border-radius:50%; background:var(--cyan);
    box-shadow:0 0 14px var(--cyan), 0 0 34px var(--cyan); animation:pulse 2s ease-in-out infinite }
  @keyframes pulse{ 0%,100%{transform:scale(.9)} 50%{transform:scale(1.2)} }

  /* layout */
  .wrap{
    position:relative; z-index:1;
    max-width:1260px; margin:0 auto; padding:24px;
    display:grid; gap:22px; grid-template-columns: 460px 1fr;
  }
  @media (max-width: 1100px){ .wrap{ grid-template-columns: 1fr } }

  .panel{
    background:
      radial-gradient(280px 160px at 20% 0%, #0f2350 0%, transparent 60%),
      radial-gradient(280px 160px at 90% 100%, #441234 0%, transparent 60%),
      linear-gradient(180deg, #0b1330, #0a1128 60%, #090f22);
    border:1px solid #2a3f85; border-radius:18px; padding:16px;
    box-shadow: inset 0 0 0 1px #00eaff22, 0 16px 40px -18px #00163a;
  }
  h3{ margin:0 0 10px; color:#dff2ff; font-size:16px; letter-spacing:.4px }
  .desc{ color:var(--muted); font-size:13px; margin:-6px 0 12px }

  /* inputs */
  textarea, input[type="text"], select{
    width:100%; background:#09143a; color:#e9f3ff; border:1px solid #25407a;
    border-radius:12px; padding:12px 12px; font-size:14px; outline:none;
    box-shadow: inset 0 0 0 1px #00eaff1a;
  }
  textarea:focus, input:focus, select:focus{
    border-color:#3c62ff; box-shadow:0 0 0 3px #3c62ff2e, inset 0 0 0 1px #00eaff4d;
  }

  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  .btn{
    appearance:none; border:1px solid #2b4aa0; background:#0b1846; color:#eaf4ff;
    padding:10px 14px; border-radius:12px; font-weight:800; font-size:14px; letter-spacing:.3px;
    cursor:pointer; transition:.18s ease; user-select:none;
    box-shadow: inset 0 0 18px #00eaff1a, 0 8px 22px -14px #001a44;
  }
  .btn:hover{ transform:translateY(-1px); border-color:#3a64d6 }
  .btn:active{ transform:translateY(0) scale(.98) }
  .btn.primary{
    background:linear-gradient(180deg, #16335f, #0d1e44);
    border-color:#4db8ff; text-shadow:0 0 10px #00eaff80;
  }
  .btn.pink{
    background:linear-gradient(180deg, #56143d, #2a0c22);
    border-color:#ff4cb7; text-shadow:0 0 10px #ff3ca680;
  }
  .btn.ghost{ background:transparent }

  label.switch{ display:inline-flex; align-items:center; gap:10px; color:#cfe3ff; font-size:13px; cursor:pointer }
  .switch input{ display:none }
  .toggle{ width:48px; height:26px; border-radius:999px; position:relative; border:1px solid #2a4f8f; background:#0b1638; box-shadow: inset 0 0 0 1px #00eaff22 }
  .toggle::after{ content:""; width:20px; height:20px; border-radius:999px; background:#ecfbff; position:absolute; top:2.7px; left:3px; transition:.22s; box-shadow:0 0 12px #00eaff7a }
  .switch input:checked + .toggle{ background:#062a36; border-color:#00eaff; box-shadow: inset 0 0 20px #00eaff55, 0 0 16px #00eaff55 }
  .switch input:checked + .toggle::after{ left: calc(100% - 23px); background:#00eaff }

  .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; max-height:160px; overflow:auto; padding-right:4px }
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
    background:linear-gradient(180deg, #0f1a44, #0b1434); border:1px solid #243a7a;
    box-shadow: inset 0 0 0 1px #00eaff20, 0 6px 20px -16px #001e44; font-size:13px; color:#deecff;
  }
  .chip .x{ width:18px; height:18px; display:grid; place-items:center; border-radius:999px; cursor:pointer; font-weight:900; background:#132047; border:1px solid #233a70; color:#a8c5ff }
  .chip .x:hover{ background:#192a5c }

  /* stage */
  .stage{
    position:relative; display:grid; place-items:center; min-height:560px; padding:0; overflow:hidden;
    border-radius:18px; border:1px solid #29408a; box-shadow: inset 0 0 0 1px #00eaff22, 0 16px 40px -18px #00163a;
    background:
      radial-gradient(600px 300px at 70% -10%, #16204f 0%, transparent 60%),
      radial-gradient(600px 300px at 30% 120%, #3a0d2e 0%, transparent 60%),
      linear-gradient(180deg, #0b1330, #0a1128 60%, #090f22);
  }
  canvas#wheel{ width:min(92vw, 600px); height:min(92vw, 600px); max-width:600px; max-height:600px }
  .pin{
    position:absolute; top:12px; width:0; height:0; border-left:20px solid transparent; border-right:20px solid transparent; border-bottom:36px solid #fff;
    filter: drop-shadow(0 0 12px #00eaffaa) drop-shadow(0 0 24px #00eaff66);
  }
  .pin::after{
    content:""; position:absolute; top:-16px; left:-13px; width:26px; height:26px; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff, #b8f6ff 40%, #00eaff 70%, #007e9a 100%);
    box-shadow: 0 0 14px #00eaff, 0 0 30px #00eaffa8;
  }
  .ring{ position:absolute; inset:16px; border-radius:50%; box-shadow: 0 0 0 2px #00eaff, 0 0 38px 2px #00eaff66, inset 0 0 40px #00eaff33, inset 0 0 200px #001c2a; pointer-events:none }

  .toast{
    position:fixed; left:50%; bottom:28px; transform:translateX(-50%) translateY(100%);
    background:linear-gradient(180deg, #101a3a, #0b132b); border:1px solid #2a4482; border-radius:14px; padding:12px 16px;
    color:#def; font-weight:800; letter-spacing:.3px; box-shadow: 0 18px 38px -22px #001c44, inset 0 0 0 1px #00eaff1a;
    z-index:7; opacity:0; transition:.35s;
  }
  .toast.show{ transform:translateX(-50%) translateY(0); opacity:1 }

  .winner-list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:4px }
  .winner{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:linear-gradient(180deg, #0d1736, #0b142e); border:1px solid #254487; padding:8px 10px; border-radius:12px; font-size:13px; color:#dff3ff }
  .winner .tag{ color:#9bffd6; font-weight:800 }

  .tiny{ font-size:12px; color:#9fb3d9 }
</style>
</head>
<body class="neon-bg">
  <div class="header">
    <div class="title"><span class="dot"></span> Lucky Wheel — Ultra Neon</div>
  </div>

  <div class="wrap">
    <!-- LEFT: Controls -->
    <div class="panel">
      <h3>Daftar Nama</h3>
      <p class="desc">Tambah satu‑satu atau tempel banyak nama (pisah baris/koma). Simpan otomatis ke browser.</p>

      <div class="row" style="margin-bottom:8px">
        <input id="nameInput" type="text" placeholder="Contoh: Siti, Budi, Ahmad … (Enter = tambah)" />
        <button id="addBtn" class="btn primary">Tambah</button>
      </div>
      <textarea id="bulkInput" rows="3" placeholder="Tempel banyak nama di sini…"></textarea>
      <div class="row" style="margin:10px 0 14px">
        <button id="bulkAddBtn" class="btn">Tambah dari Textarea</button>
        <button id="shuffleBtn" class="btn">Shuffle</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <div class="chips" id="chipList"></div>

      <hr style="border:none;border-top:1px solid #2a3f85; margin:16px 0">

      <!-- RIG: Tentukan pemenang -->
      <h3>Atur Pemenang (Opsional)</h3>
      <p class="desc">Centang & pilih nama untuk dijadikan pemenang berikutnya.</p>
      <div class="row" style="align-items:center">
        <label class="switch">
          <input id="rigToggle" type="checkbox" />
          <span class="toggle"></span>
          <span>Aktifkan “Tentukan Pemenang”</span>
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="rigSelect" disabled>
          <option value="">— pilih nama —</option>
        </select>
        <button id="rigRandomBtn" class="btn small" style="font-size:12px">Random pilih</button>
      </div>
      <div class="tiny" style="margin-top:6px">Kalau dinonaktifkan, pemenang dipilih acak seperti biasa.</div>

      <hr style="border:none;border-top:1px solid #2a3f85; margin:16px 0">

      <div class="row" style="justify-content:space-between; align-items:center">
        <label class="switch">
          <input id="excludeWinners" type="checkbox" checked />
          <span class="toggle"></span>
          <span>Exclude pemenang dari wheel</span>
        </label>
        <button id="spinBtn" class="btn pink" style="min-width:170px">SPIN 10x CEPAT ⚡</button>
      </div>

      <div class="tiny" style="margin-top:8px">Spin: fase cepat ≥10 putaran, lalu slow‑motion presisi ke pemenang.</div>
    </div>

    <!-- RIGHT: Wheel -->
    <div class="stage panel">
      <div class="pin" aria-hidden="true"></div>
      <canvas id="wheel" width="900" height="900" aria-label="Lucky wheel"></canvas>
      <div class="ring" aria-hidden="true"></div>
    </div>

    <!-- Winners -->
    <div class="panel" style="grid-column: 1 / -1">
      <h3>Histori Pemenang</h3>
      <div class="row" style="margin-bottom:8px">
        <button id="undoWinBtn" class="btn small">Undo pemenang terakhir</button>
        <button id="exportWinBtn" class="btn small">Export CSV</button>
        <button id="clearWinBtn" class="btn small ghost">Clear histori</button>
      </div>
      <div id="winnerList" class="winner-list"></div>
    </div>
  </div>

  <div id="toast" class="toast">Pemenang: —</div>
  <canvas id="confetti" style="position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:6"></canvas>

<script>
(() => {
  /* ================== STATE & STORAGE ================== */
  const STORAGE_KEY = 'ultra-luckywheel.v1';
  const DEFAULT_NAMES = ["Aiman","Budi","Citra","Dewi","Eka","Farah","Gilang","Hana"];
  const state = {
    names: [],
    winners: [],
    exclude: true,
    angle: 0,             // current angle (rad)
    rigEnabled: false,    // fixed winner enabled
    rigName: ""           // fixed winner name
  };

  function save(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        names: state.names,
        winners: state.winners,
        exclude: state.exclude,
        rigEnabled: state.rigEnabled,
        rigName: state.rigName
      }));
    }catch(e){}
  }
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) throw 0;
      const obj = JSON.parse(raw);
      state.names = Array.isArray(obj.names) ? obj.names : [];
      state.winners = Array.isArray(obj.winners) ? obj.winners : [];
      state.exclude = !!obj.exclude;
      state.rigEnabled = !!obj.rigEnabled;
      state.rigName = obj.rigName || "";
    }catch{
      state.names = [...DEFAULT_NAMES];
      state.winners = [];
      state.exclude = true;
      state.rigEnabled = false;
      state.rigName = "";
    }
  }

  /* ================== ELEMENTS ================== */
  const wheel = document.getElementById('wheel');
  const ctx = wheel.getContext('2d');
  const chipList = document.getElementById('chipList');
  const nameInput = document.getElementById('nameInput');
  const bulkInput = document.getElementById('bulkInput');
  const addBtn = document.getElementById('addBtn');
  const bulkAddBtn = document.getElementById('bulkAddBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const clearBtn = document.getElementById('clearBtn');
  const spinBtn = document.getElementById('spinBtn');
  const excludeWinners = document.getElementById('excludeWinners');
  const winnerList = document.getElementById('winnerList');
  const undoWinBtn = document.getElementById('undoWinBtn');
  const exportWinBtn = document.getElementById('exportWinBtn');
  const clearWinBtn = document.getElementById('clearWinBtn');
  const toast = document.getElementById('toast');

  const rigToggle = document.getElementById('rigToggle');
  const rigSelect = document.getElementById('rigSelect');
  const rigRandomBtn = document.getElementById('rigRandomBtn');

  /* ================== HELPERS ================== */
  const PI2 = Math.PI * 2;
  const TOP = -Math.PI/2; // pointer at top
  function rand(min,max){ return Math.random()*(max-min)+min; }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
  function normalize(rad){ rad%=PI2; if(rad<0) rad+=PI2; return rad; }
  function showToast(text){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2200); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* ================== DRAW WHEEL ================== */
  function drawWheel(){
    const names = state.names.length ? state.names : ["—"];
    const N = names.length;
    const cx = wheel.width/2, cy = wheel.height/2;
    const R  = Math.min(cx,cy) - 30;
    ctx.clearRect(0,0,wheel.width,wheel.height);

    // background glow
    const g = ctx.createRadialGradient(cx,cy, R*0.1, cx,cy,R);
    g.addColorStop(0, "#04101a");
    g.addColorStop(.7, "#07162a");
    g.addColorStop(1, "#031018");
    ctx.fillStyle = g; ctx.beginPath(); ctx.arc(cx,cy,R+22,0,PI2); ctx.fill();

    const base = PI2/N;
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(state.angle);

    for(let i=0;i<N;i++){
      const a0 = i*base, a1=a0+base, mid=(a0+a1)/2;
      // slice gradient (triple neon alt)
      const grd = ctx.createLinearGradient(0,0, Math.cos(mid)*R, Math.sin(mid)*R);
      if(i%3===0){ grd.addColorStop(0,"#0a3859"); grd.addColorStop(1,"#04243a"); }
      else if(i%3===1){ grd.addColorStop(0,"#3a0c2b"); grd.addColorStop(1,"#23081d"); }
      else{ grd.addColorStop(0,"#22164e"); grd.addColorStop(1,"#170f39"); }

      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,a0,a1); ctx.closePath();
      ctx.fillStyle = grd; ctx.fill();
      // border neon
      ctx.strokeStyle = i%3===0? "#00eaff88" : i%3===1? "#ff3ca688" : "#7c5cff88";
      ctx.lineWidth = 1.2; ctx.stroke();

      // label
      ctx.save();
      ctx.rotate(mid);
      ctx.textAlign="right"; ctx.fillStyle="#f1fbff"; ctx.font="700 26px Segoe UI, Inter, Arial";
      const label = String(names[i]);
      const maxW = R*0.86; let show=label;
      while(ctx.measureText(show).width>maxW && show.length>3){ show=show.slice(0,show.length-2) }
      if(show!==label) show=show.trim()+"…";
      ctx.shadowColor = i%3===0? "#00eaff" : i%3===1? "#ff3ca6" : "#7c5cff";
      ctx.shadowBlur = 16;
      ctx.fillText(show, R-18, 8);
      ctx.shadowBlur = 0; ctx.restore();
    }

    // center cap
    ctx.beginPath(); ctx.arc(0,0, R*0.18, 0, PI2);
    const cg = ctx.createRadialGradient(0,0,8,0,0,R*0.18);
    cg.addColorStop(0,"#ffffff"); cg.addColorStop(1,"#8ae9ff");
    ctx.fillStyle=cg; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle="#00eaff"; ctx.stroke();

    ctx.restore();
    // outer rim
    ctx.beginPath(); ctx.arc(cx,cy,R+7,0,PI2);
    ctx.strokeStyle="#00eaff"; ctx.lineWidth=3; ctx.shadowColor="#00eaff"; ctx.shadowBlur=18; ctx.stroke(); ctx.shadowBlur=0;
  }

  function indexAtPointer(){
    const N = state.names.length;
    if(!N) return -1;
    const base = PI2/N;
    let local = normalize(TOP - state.angle);
    return Math.floor(local/base);
  }

  /* ================== SPIN: FAST 10x THEN SLOW ================== */
  let spinning=false;
  function spin(){
    const N = state.names.length;
    if(!N){ showToast("Tambahkan nama dulu 🙏"); return; }
    if(spinning) return;

    // Determine target index (rig or random)
    let targetIndex = 0;
    if(state.rigEnabled && state.rigName && state.names.includes(state.rigName)){
      targetIndex = state.names.indexOf(state.rigName);
    }else{
      targetIndex = Math.floor(Math.random()*N);
    }

    // compute exact target angle for slice center under pointer
    const base = PI2/N;
    const targetCenter = targetIndex*base + base/2;
    // we want local angle at pointer to be targetCenter => angle_final ≡ TOP - targetCenter
    const idealAngle = TOP - targetCenter;

    // Two-phase spin:
    // Phase A: FAST constant angular speed, ~8 rotations
    // Phase B: EASE-OUT slow motion to land exactly at idealAngle after additional ~2+ rotations
    const phaseA_rotations = 8;               // >= 8 putaran cepat
    const phaseB_rotations = 2 + Math.floor(rand(0,2)); // 2..3 putaran saat melambat
    const phaseA_duration = 1800;             // ms (cepat)
    const phaseB_duration = 2200;             // ms (melambat)

    const startAngle = state.angle;
    // End of phase A angle (spin clockwise = decreasing angle)
    const phaseA_end = startAngle - phaseA_rotations*PI2;

    // For phase B: we must end at idealAngle - k*2π (to keep direction), solve k so result < phaseA_end
    // Choose k = phaseB_rotations
    let phaseB_end = idealAngle - phaseB_rotations*PI2;

    spinning = true; spinBtn.disabled=true;

    const t0 = performance.now();

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    function frame(now){
      const t = now - t0;
      if(t < phaseA_duration){
        // linear fast
        const p = t/phaseA_duration;
        state.angle = startAngle + (phaseA_end - startAngle)*p;
        drawWheel();
        requestAnimationFrame(frame);
      }else if(t < phaseA_duration + phaseB_duration){
        // slow motion ease-out to precise stop
        const p = (t - phaseA_duration)/phaseB_duration;
        const eased = easeOutCubic(p);
        state.angle = phaseA_end + (phaseB_end - phaseA_end)*eased;
        drawWheel();
        requestAnimationFrame(frame);
      }else{
        // snap & finish
        state.angle = phaseB_end;
        drawWheel();
        spinning=false; spinBtn.disabled=false;

        const idx = indexAtPointer();
        const winner = state.names[idx] || "—";
        onWin(winner, idx);
      }
    }
    requestAnimationFrame(frame);
  }

  function onWin(winner, idx){
    state.winners.unshift({name:winner, at:new Date().toISOString()});
    renderWinners();
    showToast("Pemenang: " + winner);
    startConfetti();

    if(state.exclude && state.names.length>1){
      state.names.splice(idx,1);
      renderChips(); drawWheel();
    }
    // if rig mode just used, keep it selected if masih ada
    if(state.rigEnabled && state.rigName && !state.names.includes(state.rigName)){
      state.rigName = ""; rigSelect.value=""; rigToggle.checked=false; rigSelect.disabled=true;
    }
    refreshRigSelect();
    save();
  }

  /* ================== RENDERERS ================== */
  function renderChips(){
    chipList.innerHTML="";
    state.names.forEach((n,i)=>{
      const c=document.createElement('div');
      c.className='chip';
      c.innerHTML=`<span>${escapeHtml(n)}</span><span class="x" title="hapus" data-i="${i}">×</span>`;
      chipList.appendChild(c);
    });
  }
  function renderWinners(){
    winnerList.innerHTML="";
    state.winners.forEach((w,i)=>{
      const row=document.createElement('div'); row.className='winner';
      const ds=new Date(w.at).toLocaleString();
      row.innerHTML=`<span><span class="tag">#${i+1}</span> ${escapeHtml(w.name)}</span><span style="color:#9db7ff">${ds}</span>`;
      winnerList.appendChild(row);
    });
  }
  function refreshRigSelect(){
    const sel = rigSelect;
    const keep = sel.value;
    sel.innerHTML = `<option value="">— pilih nama —</option>` + state.names.map(n=>`<option>${escapeHtml(n)}</option>`).join('');
    // reselect previous if exists
    const exists = state.names.includes(keep);
    sel.value = exists ? keep : "";
    if(state.rigEnabled){ sel.disabled=false; } else { sel.disabled=true; }
  }

  /* ================== CONFETTI ================== */
  const cfCanvas=document.getElementById('confetti');
  const cf=cfCanvas.getContext('2d');
  let confettiArr=[], confettiActive=false;
  function resizeConfetti(){
    cfCanvas.width=innerWidth*devicePixelRatio;
    cfCanvas.height=innerHeight*devicePixelRatio;
    cf.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  addEventListener('resize', resizeConfetti, {passive:true}); resizeConfetti();

  function startConfetti(){
    confettiArr=[]; confettiActive=true;
    const N=160;
    for(let i=0;i<N;i++){
      confettiArr.push({
        x: Math.random()*innerWidth,
        y: -20 - Math.random()*innerHeight*.4,
        vx: rand(-0.6,0.6), vy: rand(2.2,4.6),
        size: rand(6,12), rot: rand(0,PI2), vr: rand(-0.2,0.2),
        color: (i%3===0?'#00eaff':(i%3===1?'#ff3ca6':'#7c5cff'))
      });
    }
    const tEnd = performance.now()+1700;
    function step(now){
      cf.clearRect(0,0,innerWidth,innerHeight);
      confettiArr.forEach(p=>{
        p.vy+=0.02; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr;
        cf.save(); cf.translate(p.x,p.y); cf.rotate(p.rot);
        cf.fillStyle=p.color; cf.fillRect(-p.size/2,-p.size/2,p.size,p.size*0.6);
        cf.restore();
      });
      if(now<tEnd && confettiActive) requestAnimationFrame(step);
      else{ confettiActive=false; cf.clearRect(0,0,innerWidth,innerHeight); }
    }
    requestAnimationFrame(step);
  }

  /* ================== UI WIRES ================== */
  addBtn.addEventListener('click', ()=>{
    const name = String(nameInput.value||"").trim();
    if(!name) return;
    if(!state.names.includes(name)) state.names.push(name);
    nameInput.value=""; renderChips(); drawWheel(); refreshRigSelect(); save(); nameInput.focus();
  });
  nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addBtn.click(); } });

  bulkAddBtn.addEventListener('click', ()=>{
    const text=String(bulkInput.value||"");
    if(!text.trim()) return;
    const parts=text.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
    let added=0; parts.forEach(p=>{ if(!state.names.includes(p)){ state.names.push(p); added++; } });
    bulkInput.value=""; if(added>0){ showToast(`Ditambahkan ${added} nama`) }
    renderChips(); drawWheel(); refreshRigSelect(); save();
  });

  chipList.addEventListener('click', (e)=>{
    const i=e.target?.dataset?.i;
    if(i!==undefined){
      const removed = state.names.splice(Number(i),1)[0];
      if(state.rigName===removed){ state.rigName=""; rigSelect.value=""; }
      renderChips(); drawWheel(); refreshRigSelect(); save();
    }
  });

  shuffleBtn.addEventListener('click', ()=>{
    shuffle(state.names); renderChips(); drawWheel(); refreshRigSelect(); save();
  });
  clearBtn.addEventListener('click', ()=>{
    if(confirm('Kosongkan semua nama?')){ state.names=[]; renderChips(); drawWheel(); refreshRigSelect(); save(); }
  });

  spinBtn.addEventListener('click', spin);

  excludeWinners.addEventListener('change', ()=>{ state.exclude=excludeWinners.checked; save(); });

  undoWinBtn.addEventListener('click', ()=>{
    const last=state.winners.shift();
    if(last){
      if(state.exclude && !state.names.includes(last.name)){ state.names.push(last.name); renderChips(); drawWheel(); refreshRigSelect(); }
      renderWinners(); save();
    }
  });
  exportWinBtn.addEventListener('click', ()=>{
    if(!state.winners.length){ showToast("Belum ada histori"); return; }
    const rows=[["No","Nama","Waktu (ISO)"]];
    state.winners.forEach((w,i)=>rows.push([i+1,w.name,w.at]));
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="winners.csv"; a.click(); URL.revokeObjectURL(a.href);
  });
  clearWinBtn.addEventListener('click', ()=>{ if(confirm('Hapus semua histori pemenang?')){ state.winners=[]; renderWinners(); save(); } });

  rigToggle.addEventListener('change', ()=>{
    state.rigEnabled = rigToggle.checked;
    rigSelect.disabled = !state.rigEnabled;
    if(!state.rigEnabled){ state.rigName=""; rigSelect.value=""; }
    save();
  });
  rigSelect.addEventListener('change', ()=>{
    state.rigName = rigSelect.value || "";
    save();
  });
  rigRandomBtn.addEventListener('click', ()=>{
    if(!state.names.length) return;
    rigToggle.checked = true; state.rigEnabled = true;
    const randName = state.names[Math.floor(Math.random()*state.names.length)];
    state.rigName = randName; refreshRigSelect(); rigSelect.value = randName; rigSelect.disabled = false; save();
  });

  /* ================== INIT ================== */
  load();
  excludeWinners.checked = state.exclude;
  rigToggle.checked = state.rigEnabled;
  renderChips(); renderWinners(); refreshRigSelect();

  // HiDPI scaling
  function fixHiDPI(){
    const cssW=wheel.clientWidth, cssH=wheel.clientHeight, ratio=window.devicePixelRatio||1;
    const needW=Math.floor(cssW*ratio), needH=Math.floor(cssH*ratio);
    if(wheel.width!==needW || wheel.height!==needH){ wheel.width=needW; wheel.height=needH; drawWheel(); }
  }
  const ro=new ResizeObserver(fixHiDPI); ro.observe(wheel); fixHiDPI();

  drawWheel();
})();
</script>
</body>
</html>
